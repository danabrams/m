name: CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  # ==========================================================================
  # Go Backend Check
  # ==========================================================================
  go-test:
    name: Go Tests
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.23'

      - name: Install dependencies
        run: go mod download

      - name: Build
        run: go build -v ./...

      - name: Run go vet
        run: go vet ./...

      - name: Run tests
        run: go test -v -race -coverprofile=coverage.out ./...

      - name: Upload coverage
        uses: codecov/codecov-action@v4
        with:
          files: coverage.out
          fail_ci_if_error: false
        env:
          CODECOV_TOKEN: ${{ secrets.CODECOV_TOKEN }}

  go-lint:
    name: Go Lint
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.23'

      - name: golangci-lint
        uses: golangci/golangci-lint-action@v6
        with:
          version: latest
          args: --timeout=5m

  # ==========================================================================
  # iOS Frontend Check
  # ==========================================================================
  ios-build:
    name: iOS Build & Test
    runs-on: macos-14

    steps:
      - uses: actions/checkout@v4

      - name: Select Xcode
        run: sudo xcode-select -s /Applications/Xcode_15.4.app/Contents/Developer

      - name: Build Swift Package
        working-directory: ios/M
        run: swift build

      - name: Run Swift tests
        working-directory: ios/M
        run: swift test

  ios-lint:
    name: Swift Lint
    runs-on: macos-14

    steps:
      - uses: actions/checkout@v4

      - name: Install SwiftLint
        run: brew install swiftlint

      - name: Run SwiftLint
        working-directory: ios
        run: swiftlint lint --strict --reporter github-actions-logging || true

  # ==========================================================================
  # E2E Tests Check (parallelized)
  # ==========================================================================
  e2e-tests:
    name: E2E Tests
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        test-suite:
          - auth
          - repos
          - runs
          - approvals
          - devices

    steps:
      - uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.23'

      - name: Install dependencies
        run: go mod download

      - name: Build server
        run: go build -v ./cmd/...

      - name: Run E2E tests - ${{ matrix.test-suite }}
        run: |
          case "${{ matrix.test-suite }}" in
            auth)
              go test -v -race -run "TestE2E_Authentication|TestE2E_HealthEndpoint" ./internal/api/...
              ;;
            repos)
              go test -v -race -run "TestE2E_Repos" ./internal/api/...
              ;;
            runs)
              go test -v -race -run "TestE2E_Runs" ./internal/api/...
              ;;
            approvals)
              go test -v -race -run "TestE2E_Approvals" ./internal/api/...
              ;;
            devices)
              go test -v -race -run "TestE2E_Devices|TestE2E_Internal|TestE2E_Error|TestE2E_Success" ./internal/api/...
              ;;
          esac
